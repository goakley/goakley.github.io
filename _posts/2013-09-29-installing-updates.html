---
layout: post
title:  "Installing Updates (do not turn off or unplug your computer)"
date:   2013-09-29
---

<p>Laptop batteries: possibly the most expensive component to replace on a laptop.  Unless you go third party, of course!</p>

<p><image src="/assets/hp.png" /></p>

<p><image src="/assets/amazon.png" /></p>

<p>What&#39;s more reliable than trusting an off-brand manufacturer to supply the driving component of your entire machine?  Probably trusting the original manufacturer to supply the driving component of your entire  machine.  Leaving my laptop on battery causes it to die:</p>

<ul>
<li>At over 90% CPU load</li>
<li>Loading a multitude of tabs in Firefox</li>
<li>Because I needed it to be on</li>
</ul>

<p>By now, I should have learned my lesson to not run <code>pacman -Su</code> on battery, but what are the odds that I&#39;ll die at 80% battery?</p>

<p>Okay, well, no big deal, I&#39;ve died during updates before, and as long as it wasn&#39;t during <code>mkinitcpio</code>, there haven&#39;t been any immediate repercussions.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">switch_root: failed to execute /sbin/init: Input/output error
[      0.000000] Kernel panic - not syncing: Attempted to kill init!
</code></pre></div>
<p>Oh dear.</p>

<p>Okay, no big deal!  There have been lots of times where I&#39;ve been left with a 0-byte file on the system; that would totally cause an I/O error.  Perhaps it had something to do with the fact that <a href="https://bbs.archlinux.org/viewtopic.php?pid=1303683#p1303683">I changed syslinux to mount rw</a>.  Regardless, time to boot off of USB!  Good thing I always have an Altoid tin full of Arch Linuxes (Linuxii?).</p>

<p>Since <code>init</code> is owned by systemd, I first decided to forcibly reinstall systemd and systemd-sysvcompat</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ mount /dev/sda1 /mnt
$ pacman -S -r /mnt --force systemd systemd-sysvcompat
$ ls -l /lib/systemd/systemd
-rwxr-xr-x 1 root root 1039792 Sep 19 18:12 /lib/systemd/systemd
</code></pre></div>
<p>Cool!  Clearly fixed!</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">switch_root: failed to execute /sbin/init: Input/output error
[      0.000000] Kernel panic - not syncing: Attempted to kill init!
</code></pre></div>
<p>wat</p>

<p>Okay, well, is this just systemd?</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">nano /mnt/boot/syslinux/syslinux.cfg
...
LABEL archfallback
...
      APPEND root=/dev/sda1 init=/bin/sh rw
...
</code></pre></div><div class="highlight"><pre><code class="text language-text" data-lang="text">switch_root: failed to execute /bin/sh: Input/output error
[      0.000000] Kernel panic - not syncing: Attempted to kill init!
</code></pre></div>
<p>...Right.  OKAY, WELL, let&#39;s think.  What was I doing when the laptop died?</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ cat /var/log/pacman.log
...
[0000-00-00 00:00] [PACMAN] starting full system upgrade*SO MUCH CORRUPTED BINARY DATA*
</code></pre></div>
<p>WELL THEN.  Maybe the packages are still there.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ ls -l /var/cache/pacman/pkg
-rw-r--r-- 1 root root 8611472 Sep 26 13:28 glibc-2.18-5-x86_64.pkg.tar.xz
-rw-r--r-- 1 root root       0 Sep 26 13:28 glm-0.9.4.6-1-any.pkg.tar.xz
-rw-r--r-- 1 root root       0 Sep 26 13:28 lib32-flashplugin-11.2.202.310-1-x86_64.pkg.tar.xz
-rw-r--r-- 1 root root       0 Sep 26 13:28 lib32-glibc-2.18-5-x86_64.pkg.tar.xz
-rwxr-xr-x 1 root root       0 Sep 26 13:28 libdvbpsi-1-1.1.0-1-x86_64.pkg.tar.xz
-rw-r--r-- 1 root root       0 Sep 26 13:28 m4-1.4.17-1-x86_64.pkg.tar.xz
-rw-r--r-- 1 root root       0 Sep 26 13:28 phonon-vlc-0.6.2-2-x86_64.pkg.tar.xz
-rw-r--r-- 1 root root       0 Sep 26 13:28 vlc-2.1.0-2-x86_64.pkg.tar.xz
</code></pre></div>
<p>wat</p>

<p>WAT</p>

<p>That might be a bit of a problem!  A quick re-download and MASSIVE FORCE INSTALL from the USB drive...</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Generating locales...
Floating Point Exception.
</code></pre></div>
<p>Reeeaaally?  Okay.  That&#39;s fine.  Fine!  Booting back to /bin/sh, and ignoring all the horrible boot warning and errors, there is a shell!</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ locale-gen
Generating locales...
  en_US.UTF-8... done
  ja_JP.UTF-8... done
  ru_RU.UTF-8... done
</code></pre></div>
<p>Reboot to /sbin/init, and fixed!  Just in time for class.  I&#39;d like to say I&#39;ve learned my lesson, but I know something like this will happen again.</p>
